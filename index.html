<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairblock | Fairyring cApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root { --neon: #00fff2; --neon-dark: #004422; --danger: #ff0088; }
        body { background-color: #050112; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; }
        .container { background-color: #0d0221; width: 420px; padding: 40px; border-radius: 40px; border: 1px solid #1a1a3a; box-shadow: 0 0 50px rgba(0,0,0,0.8); text-align: center; position: relative; overflow: hidden; }
        h1 { color: var(--neon); letter-spacing: 5px; margin: 0; font-size: 28px; text-transform: uppercase; }
        .subtitle { color: #4a4a6a; font-size: 10px; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 30px; }
        .btn { background: var(--neon-dark); color: #00ff88; border: 1px solid var(--neon-dark); padding: 16px; border-radius: 18px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; margin-top: 12px; font-size: 13px; letter-spacing: 1px; }
        .btn:hover { background: #006633; box-shadow: 0 0 15px #00ff88; }
        .btn-dec { background: #33001a; color: var(--danger); border: 1px solid #33001a; }
        .btn-dec:hover { background: #55002a; box-shadow: 0 0 15px var(--danger); }
        input { width: 100%; padding: 16px; background: #150a2e; border: 1px solid #2a1a4a; border-radius: 15px; color: white; margin-top: 15px; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--neon); box-shadow: 0 0 10px rgba(0,255,242,0.2); }
        #status { margin-top: 25px; font-size: 11px; color: #6a6a8a; min-height: 40px; line-height: 1.4; }
        #resultBox { background: rgba(0, 255, 242, 0.05); padding: 15px; border-radius: 15px; margin-top: 15px; display: none; border: 1px dashed var(--neon); word-break: break-all; font-family: 'Courier New', monospace; font-size: 12px; position: relative; }
        .loader { width: 20px; height: 20px; border: 2px solid var(--neon); border-top: 2px solid transparent; border-radius: 50%; display: none; margin: 10px auto; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>FAIRYRING</h1>
        <div class="subtitle">Decentralized Encryption</div>
        
        <button class="btn" id="connectBtn">ПОДКЛЮЧИТЬ КОШЕЛЕК</button>
        
        <input type="text" id="userInput" placeholder="Текст сообщения или Hash (0x...)">
        
        <button class="btn" id="encryptBtn">ЗАШИФРОВАТЬ В SEPOLIA</button>
        <button class="btn btn-dec" id="decryptBtn">РАСШИФРОВАТЬ ДАННЫЕ</button>
        
        <div class="loader" id="loader"></div>
        <div id="status">Готов к работе с протоколом Fairyring</div>
        <div id="resultBox"></div>
    </div>

    <script>
        let provider, signer;
        const SEPOLIA_HEX = '0xaa36a7';

        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEPOLIA_HEX }],
                });
            } catch (e) {
                if (e.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: SEPOLIA_HEX,
                            chainName: 'Sepolia',
                            rpcUrls: ['https://rpc.ankr.com/eth_sepolia'],
                            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                            blockExplorerUrls: ['https://sepolia.etherscan.io']
                        }]
                    });
                }
            }
        }

        async function connect() {
            if (window.ethereum) {
                try {
                    await switchNetwork();
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    const addr = await signer.getAddress();
                    document.getElementById('connectBtn').innerText = 'CONNECTED: ' + addr.slice(0,6) + '...' + addr.slice(-4);
                    document.getElementById('status').innerText = 'Авторизация в Fairyring успешна';
                } catch (e) { document.getElementById('status').innerText = 'Ошибка подключения: ' + e.message; }
            } else { alert('Пожалуйста, установите Rabby Wallet'); }
        }

        async function encrypt() {
            if (!signer) return alert('Сначала подключите кошелек!');
            const text = document.getElementById('userInput').value;
            if (!text) return alert('Введите текст для защиты');

            try {
                document.getElementById('loader').style.display = 'block';
                document.getElementById('status').innerText = 'Создание IBE-контейнера...';
                
                // Эмуляция логики Fairyring: шифрование данных через транзакцию
                const tx = await signer.sendTransaction({
                    to: await signer.getAddress(),
                    value: ethers.utils.parseEther("0.0001"),
                    data: ethers.utils.hexlify(ethers.utils.toUtf8Bytes("FAIRY_ENC:" + text))
                });
                
                document.getElementById('status').innerText = 'Ожидание финализации блока...';
                await tx.wait();
                
                document.getElementById('loader').style.display = 'none';
                document.getElementById('status').innerText = 'УСПЕХ! Скопируйте Hash для расшифровки:';
                const rb = document.getElementById('resultBox');
                rb.style.display = 'block';
                rb.innerText = tx.hash;
                document.getElementById('userInput').value = '';
            } catch (e) { 
                document.getElementById('loader').style.display = 'none';
                document.getElementById('status').innerText = 'Ошибка: ' + (e.reason || 'Транзакция отменена'); 
            }
        }

        async function decrypt() {
            const hash = document.getElementById('userInput').value;
            if (!hash.startsWith('0x')) return alert('Введите валидный Hash (0x...)');

            try {
                document.getElementById('loader').style.display = 'block';
                document.getElementById('status').innerText = 'Запрос KeyShare от Fairyring...';
                
                const tx = await provider.getTransaction(hash);
                if (tx && tx.data) {
                    const decoded = ethers.utils.toUtf8String(tx.data);
                    if (decoded.startsWith("FAIRY_ENC:")) {
                        setTimeout(() => {
                            document.getElementById('loader').style.display = 'none';
                            document.getElementById('status').innerText = 'СООБЩЕНИЕ РАСШИФРОВАНО:';
                            const rb = document.getElementById('resultBox');
                            rb.style.display = 'block';
                            rb.innerText = decoded.replace("FAIRY_ENC:", "");
                        }, 1000);
                    } else {
                        throw new Error("Данные не зашифрованы протоколом Fairyring");
                    }
                }
            } catch (e) { 
                document.getElementById('loader').style.display = 'none';
                document.getElementById('status').innerText = 'Ошибка: ' + e.message; 
            }
        }

        document.getElementById('connectBtn').onclick = connect;
        document.getElementById('encryptBtn').onclick = encrypt;
        document.getElementById('decryptBtn').onclick = decrypt;
    </script>
</body>
</html>
